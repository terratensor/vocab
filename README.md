# Vocab

Vocab — это инструмент для создания словаря из текстовых файлов. Он поддерживает токенизацию, фильтрацию знаков препинания, приведение к нижнему регистру, сортировку по частоте или алфавиту, а также обработку файлов в формате `.gz`.

В папке `vocab` содержаться сформированные с разными параметрами словари 50 книг ВП СССР в папке `./books`. 

Например, [vocab/vocab_alpha.txt](https://github.com/terratensor/vocab/blob/main/vocab/vocab_alpha.txt) содержит словарь КОБ, отсортированный по алфавиту.

## Установка

1. Убедитесь, что у вас установлен Go (версия 1.16 или выше).
2. Установите проект:

   ```bash
   go install github.com/terratensor/vocab/cmd/vocab@latest
   ```

### Использование

#### Сценарий 1: Создание нового словаря из файлов в директории

```bash
vocab -dir=/path/to/files -output=vocab.txt -sort=freq -lowercase=true -filter-punct=true
```

#### Сценарий 2: Обработка готового словаря

```bash
vocab -input=vocab.txt -output=vocab_processed.txt -sort=freq -lowercase=true -filter-punct=true
```

### Сценарий 3: Объединение словарей

Объединяет несколько словарей из файлов в один, применяя все доступные функции (сортировка, фильтрация, приведение к нижнему регистру).

#### Пример:
```bash
vocab -inputs=vocab1.txt,vocab2.txt,vocab3.txt -output=merged_vocab.txt -sort=freq -lowercase=true
```

### Флаги

- `-dir`: Путь к директории с текстовыми файлами (по умолчанию: не указан).
- `-input`: Путь к файлу с уже сформированным словарем (по умолчанию: не указан).
- `-inputs`: Список файлов словарей через запятую (например, `vocab1.txt,vocab2.txt`).
- `-output`: Имя выходного файла (по умолчанию: `vocab.txt`).
- `-sort`: Тип сортировки (`freq` для частоты, `alpha` для алфавитной сортировки).
- `-lowercase`: Приводить токены к нижнему регистру (по умолчанию: `false`).
- `-filter-punct`: Фильтровать знаки препинания (по умолчанию: `false`).
- `-max-goroutines`: Максимальное количество горутин (по умолчанию: количество процессоров).
- `-pprof`: Включить профилирование с помощью `pprof` (по умолчанию: `false`).


### Обработка `.gz` файлов   
Программа автоматически распаковывает файлы с расширением `.gz` перед обработкой.

### Примеры использования:

1. **Создание нового словаря**:
   ```bash
   go run main.go -dir=./files -output=vocab.txt -sort=freq -lowercase=true
   ```

2. **Обработка готового словаря**:
   ```bash
   go run main.go -input=vocab.txt -output=vocab_processed.txt -sort=alpha -filter-punct=true
   ```
3. **Объединение словарей**:
   ```bash
   go run main.go -inputs=vocab1.txt,vocab2.txt,vocab3.txt -output=merged_vocab.txt -sort=freq -lowercase=true
   ```
   Вывод:
   ```bash
   Using 6 goroutines (number of CPUs)
   Starting to merge vocabularies...
   Reading and merging file 3/3: vocab3.txt
   Merging completed.
   Processing vocabulary...
   Processed 10977211/10977211 tokens (100%)
   Processing completed.
   Saving vocabulary...
   Sorting vocabulary...
   Sorting completed in 416.1916ms.
   Saved 10977211/10977211 tokens (100%)
   Saving completed.
   Merged vocabulary saved to merged_vocab.txt

   ```
4. **Профилирование**:
   ```bash
   go run main.go -dir=./files -output=vocab.txt -pprof=true

   ```

### Как это работает:

1. **Сценарий 1: Создание нового словаря**:
   - Если указан флаг `-dir`, программа создает словарь из файлов в указанной директории.
   - Используются все текущие функции: токенизация, фильтрация, сортировка и т.д.

2. **Сценарий 2: Обработка готового словаря**:
   - Если указан флаг `-input`, программа загружает готовый словарь из файла.
   - Применяются операции: приведение к нижнему регистру, удаление пунктуации, сортировка.
   - Результат сохраняется в новый файл.

3. **Сценарий 3: Объединение словарей**:
   - Если указан флаг `-inputs`, программа объединяет несколько словарей из файлов.
   - Используются все текущие функции: токенизация, фильтрация, сортировка и т.д.
   - Результат сохраняется в новый файл.

4. **Профилирование**:
   - Если включен флаг `-pprof`, программа запускает HTTP-сервер для сбора данных профилирования.

---

### Логирование ошибок

Если при обработке файла возникает ошибка, программа:

1. Записывает ошибку в лог-файл vocab_errors/vocab_errors.log.

2. Копирует проблемный файл в папку vocab_errors.

Пример лога:

```bash 
2023/10/10 12:34:56 Error opening file ./books/broken_file.txt: file not found
```

### Профилирование с помощью `pprof`

Для анализа производительности программы можно включить профилирование:

```bash
vocab -dir=./books -output=vocab.txt -pprof=true
```
После запуска откройте браузер и перейдите по адресу: `http://localhost:6060/debug/pprof/`.

### Анализ данных:

- Используйте команду go tool pprof для анализа данных. Например:

   ```bash
   go tool pprof http://localhost:6060/debug/pprof/profile
   ```
- После запуска команды вы попадете в интерактивный режим pprof. Используйте команды:

   - top — показать самые ресурсоемкие функции.

   - list <функция> — показать код функции.

   - web — открыть визуализацию в браузере.

#### Пример анализа CPU:

```bash
go tool pprof http://localhost:6060/debug/pprof/profile
```

### Пример анализа памяти:

```bash
go tool pprof http://localhost:6060/debug/pprof/heap
```

### Профилирование горутин:

```bash
go tool pprof http://localhost:6060/debug/pprof/goroutine
```

## Лицензия
Этот проект распространяется под лицензией MIT. См. LICENSE.


## Что дальше?

#### 1. Тестирование:
 - Написать unit-тесты для пакета tokenizer.
 - Использовать go test для проверки корректности работы.

#### 2. CI/CD:
 - Настроить GitHub Actions для автоматического тестирования и сборки.

#### 3. Документация:

 - Добавить примеры использования в README.md.

 - Создать документацию с помощью godoc.

#### 4. Оптимизация:

 - Профилировать программу с помощью pprof для поиска узких мест.

#### 5. Расширение функционала:

 - Добавить поддержку других форматов файлов (например, PDF, DOCX).

 - Реализовать фильтрацию стоп-слов.

#### 6. Публикация:

 - Опубликовать пакет в Go Module Registry.

